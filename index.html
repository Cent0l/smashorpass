<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smash or Pass – demo</title>
  <style>
    :root {
      --bg: #0b0d12; --card:#151923; --muted:#9aa3b2; --text:#e8eefc; --accent:#6aa6ff; --bad:#f87171; --good:#34d399;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(180deg,#0b0d12 0%,#0f1320 100%);color:var(--text);}
    header{max-width:960px;margin:24px auto 8px;padding:0 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0;letter-spacing:.4px}
    .hint{font-size:13px;color:var(--muted)}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .arena{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #263042;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;min-height:420px;box-shadow:0 6px 30px rgba(0,0,0,.3)}
    .media{position:relative;aspect-ratio:1/1;display:grid;place-items:center;background:#0c1018}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .label{padding:12px 14px;border-top:1px solid #263042;display:flex;align-items:center;gap:8px}
    .label b{font-size:15px}
    button.pick{margin:12px 14px 16px;padding:12px 14px;border-radius:12px;border:1px solid #2a3a55;background:#152036;color:var(--text);cursor:pointer;font-weight:600}
    button.pick:hover{filter:brightness(1.1)}
    .left button.pick{outline:2px solid transparent}
    .right button.pick{outline:2px solid transparent}
    .left button.pick.choose{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.35)}
    .right button.pick.choose{background:rgba(106,166,255,.12);border-color:rgba(106,166,255,.4)}
    .err{position:absolute;inset:auto 8px 8px 8px;background:rgba(12,16,24,.85);border:1px dashed #43516d;border-radius:10px;padding:10px;color:var(--muted);font-size:12px}
    .controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    .controls .key{border:1px solid #2a3a55;border-radius:8px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .progress{margin:18px auto 8px;max-width:960px;height:8px;background:#121827;border:1px solid #263042;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#9b7bff)}
    .hidden{display:none}
    /* Summary */
    .summary{max-width:1000px;margin:28px auto;padding:0 16px}
    .summary h2{font-size:18px;margin:6px 0 14px;color:#d7dff0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .tile{background:#101520;border:1px solid #243042;border-radius:12px;overflow:hidden}
    .tile img{width:100%;height:120px;object-fit:cover;display:block}
    .tile .cap{padding:8px 10px;font-size:13px;color:#c6d0e3}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #30415b;font-size:12px;color:var(--muted)}
    .lists{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:820px){.arena{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Smash or Pass</h1>
    <div class="hint">Sterowanie: ←/A wybiera lewą, →/D prawą • Kliknięcie też działa</div>
  </header>

  <div class="progress"><div class="bar" id="bar"></div></div>

  <div class="wrap">
    <section id="game" class="arena" aria-live="polite"></section>

    <div class="controls" id="controls"></div>

    <section id="summary" class="summary hidden"></section>
  </div>

  <script>
  // === KONFIG DANYCH ===
  // Ładujemy dokładnie taki format jak przesłałeś:
  // {
  //   "pairs": [
  //     { "left": {"id":"1","title":"...","img":"img/1.png"},
  //       "right": {"id":"2","title":"...","img":"img/2.png"} },
  //     ...
  //   ]
  // }

  const PATH_JSON = './data/pairs.json';

  const state = { i: 0, pairs: [], chosen: [], rejected: [] };

  const gameEl = document.getElementById('game');
  const barEl = document.getElementById('bar');
  const summaryEl = document.getElementById('summary');
  const controlsEl = document.getElementById('controls');

  // Utils
  function isUrlLike(s){
    if(!s) return false;
    // traktuj jako gotową ścieżkę jeśli to URL lub już zawiera separator katalogu
    return /^(https?:)?\/\//.test(s) || s.startsWith('./') || s.startsWith('../') || s.startsWith('/') || s.includes('/');
  }
  function withImgPrefix(src){
    // Jeśli w JSON podasz np. "1.png" => dopniemy ./img/1.png
    // Jeśli podasz "img/1.png" albo dowolną ścieżkę/URL => zostawiamy jak jest
    return isUrlLike(src) ? src : `./img/${src}`;
  }
  function escapeHtml(s){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  }
  function setProgress(){
    const pct = state.pairs.length ? (state.i / state.pairs.length) * 100 : 0;
    barEl.style.width = pct + '%';
  }
  function preload(src){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=> resolve({ ok:true, img });
      img.onerror = ()=> resolve({ ok:false });
      img.src = src;
    });
  }

  // Normalizacja DOKŁADNIE pod Twój schemat
  function normalizePairsFromExact(json){
    const arr = Array.isArray(json?.pairs) ? json.pairs : [];
    return arr.map(item => {
      const L = item?.left ?? {}; const R = item?.right ?? {};
      const left = {
        id: L.id ?? null,
        label: L.title ?? (L.img ? L.img.split('/').pop() : ''),
        src: withImgPrefix(L.img ?? L.src ?? L.path ?? '')
      };
      const right = {
        id: R.id ?? null,
        label: R.title ?? (R.img ? R.img.split('/').pop() : ''),
        src: withImgPrefix(R.img ?? R.src ?? R.path ?? '')
      };
      return { left, right };
    }).filter(p => p.left.src && p.right.src);
  }

  async function boot(){
    try{
      const res = await fetch(PATH_JSON, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      state.pairs = normalizePairsFromExact(json);
      if(!state.pairs.length){ throw new Error('Brak par w pliku JSON.'); }
      renderPair();
    }catch(err){
      console.error('Błąd ładowania JSON:', err);
      gameEl.innerHTML = `
        <div class="card" style="grid-column:1/-1;min-height:auto">
          <div class="label"><b>Nie udało się wczytać ./data/pairs.json</b></div>
          <div class="label" style="color:#9aa3b2">Sprawdź ścieżkę, gałąź Pages i format danych. Szczegóły w konsoli.</div>
        </div>`;
    }
  }

  async function renderPair(){
    gameEl.innerHTML = '';
    controlsEl.innerHTML = '';
    setProgress();
    if(state.i >= state.pairs.length){
      return showSummary();
    }
    const pair = state.pairs[state.i];
    const [pl, pr] = await Promise.all([preload(pair.left.src), preload(pair.right.src)]);

    const leftCard = createCard(pair.left, 'left', pl.ok);
    const rightCard = createCard(pair.right, 'right', pr.ok);
    gameEl.appendChild(leftCard);
    gameEl.appendChild(rightCard);

    const next = state.pairs[state.i+1];
    if(next){ preload(next.left.src); preload(next.right.src); }

    controlsEl.innerHTML = '<span class="key">← / A</span> wybierz lewą • <span class="key">→ / D</span> wybierz prawą';
  }

  function createCard(item, side, ok){
    const card = document.createElement('article');
    card.className = `card ${side}`;

    const media = document.createElement('div');
    media.className = 'media';
    const img = document.createElement('img');
    img.alt = item.label || '';
    img.src = item.src;
    media.appendChild(img);
    if(!ok){
      const err = document.createElement('div');
      err.className = 'err';
      err.textContent = 'Nie udało się wczytać obrazu. Sprawdź ścieżkę/HTTPS i wielkość liter w nazwie pliku.';
      media.appendChild(err);
    }

    const label = document.createElement('div');
    label.className = 'label';
    label.innerHTML = `<span class="pill">${side==='left'?'lewa':'prawa'}</span> <b>${escapeHtml(item.label)}</b>`;

    const btn = document.createElement('button');
    btn.className = 'pick';
    btn.textContent = side==='left' ? 'Wybieram lewą' : 'Wybieram prawą';
    btn.addEventListener('click', ()=> choose(side));

    card.append(media,label,btn);
    card.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()!=='button') choose(side); });
    return card;
  }

  function choose(side){
    const pair = state.pairs[state.i];
    const pick = side==='left' ? pair.left : pair.right;
    const reject = side==='left' ? pair.right : pair.left;
    state.chosen.push(pick);
    state.rejected.push(reject);
    state.i++;
    renderPair();
  }

  function renderGrid(items){
    const tiles = items.map(it=> `
      <div class="tile">
        <img src="${it.src}" alt="${escapeHtml(it.label)}" onerror="this.parentElement.querySelector('.cap').textContent='[BŁĄD OBRAZU] '+this.parentElement.querySelector('.cap').textContent"/>
        <div class="cap">${escapeHtml(it.label)}</div>
      </div>
    `).join('');
    return `<div class="grid">${tiles}</div>`;
  }

  function showSummary(){
    document.getElementById('game').classList.add('hidden');
    controlsEl.classList.add('hidden');
    summaryEl.classList.remove('hidden');

    const chosenGrid = renderGrid(state.chosen);
    const rejectedGrid = renderGrid(state.rejected);

    summaryEl.innerHTML = `
      <h2>Podsumowanie</h2>
      <div class="lists">
        <div>
          <h3>Wybrane (${state.chosen.length})</h3>
          ${chosenGrid}
        </div>
        <div>
          <h3>Odrzucone (${state.rejected.length})</h3>
          ${rejectedGrid}
        </div>
      </div>
    `;
  }

  // Klawiatura
  addEventListener('keydown', (e)=>{
    if(summaryEl && !summaryEl.classList.contains('hidden')) return;
    if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A') { choose('left'); }
    if(e.key==='ArrowRight'|| e.key==='d' || e.key==='D') { choose('right'); }
  });

  // Start po załadowaniu DOM
  document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
